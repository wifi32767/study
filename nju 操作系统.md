网课：https://www.bilibili.com/video/BV1Cm4y1d7Ur  
课程网站：https://jyywiki.cn/OS/2022/index.html
# 1.操作系统概述
### 什么是操作系统
让运行程序变得简单的软件，让程序并行，共享内存，与设备交互，等等  
精准的定义毫无意义，要理解什么是操作系统，必须要看硬件、程序、操作系统经历了怎样的发展  
- 1940s  
  - 程序能跑起来就行了，不需要操作系统
- 1950s
  - 计算机非常昂贵，产生了集中管理计算机的需求
  - 需要程序管理程序的自动切换
  - 操作系统还可以提供库函数
- 1960s
  - 内存变大，可以存储多个程序
  - IO太慢导致CPU资源浪费，出现了进程的概念
  - 地址空间隔离和虚拟存储让一个有bug的程序不会影响整个系统
  - 时钟中断和调度系统使得现代操作系统诞生
- 1970s+
  - 操作系统走向成熟

三个根本问题：
1. 操作系统服务谁
2. 操作系统为程序提供什么服务
3. 如何实现操作系统的服务

这门课讲的是狭义的操作系统，必须管理一台计算机，必须服务二进制代码

### 怎么学操作系统
使用正确的工具  
多写代码

# 2.操作系统上的程序
### 状态机
状态：寄存器的值  
初始状态：RESET  
迁移：计算下一周期的值  
UNIX哲学：把一个程序的输出作为另一个程序的输入  

### 什么是程序
程序就是状态机

一个重要的工具：gdb  
C程序的状态机模型：  
- 状态：堆栈  
  - 栈帧的列表+全局变量
- 初始状态：main的第一条语句
  - 全局变量初始化  
- 迁移：执行一条语句  
  - 执行栈顶部帧的语句，PC++  
  - 函数调用=入栈，函数返回=出栈  

二进制程序的状态机模型
- 状态：内存M+寄存器R
- 初始状态：稍后回答
- 迁移：执行一条指令

操作系统上的程序所有的指令都只能计算，无法停下来  
程序 = 指令 + systemcall(系统调用)  
进程把M和R交给操作系统，任其自由修改，实现了程序与操作系统内其他对象交互  
程序的本质是计算，然后在适当的时候调用systemcall，让操作系统帮忙完成剩下的工作  
查看syscall的手册得到这些信息  

### 什么是编译器
状态机顺便解决了一个基本问题：什么是编译器？  
什么是编译正确？
- C代码定义了一个状态机，汇编代码也定义了一个状态机，正确编译就是C代码中所有不可优化的部分都翻译到了汇编代码中
- 源代码S和二进制代码C，二者的可观测行为严格一致

现代与未来的编译优化，在保证观测一致的情况下改写代码，提升性能。  
比如内联优化、合并可优化部分  
还有很大的发挥空间，比如AI编译、合并不可优化部分  

### 操作系统中的程序是什么
仍然是计算和syscall，因而计算机系统不存在玄学，一切都建立在确定的机制上  
应用看到的操作系统就是syscall，操作系统里面有很多对象，可以通过syscall访问各种api  
操作系统集中管理了所有的软硬件资源，会决定程序是否有权限  

另一个重要的工具：strace  
使用strace可以看到一个程序执行完整的系统调用  
- 被另一个进程用execve设置为初始状态
- 进程管理：fork、execve、exit
- 文件/设备管理：open、read、write、close
- 存储管理：mmap、brk
- 直到_exit退出

所有软件都是由这些api实现的